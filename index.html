<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VK –¢–æ–∫–µ–Ω –•–µ–ª–ø–µ—Ä</title>
    <style>
        /* –°—Ç–∏–ª–∏ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –≤ –≤–∞—à–µ–π –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #4a76a8, #2c3e50);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }
        .card {
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }
        h1 { color: #333; font-size: 32px; margin-bottom: 10px; text-align: center; }
        .subtitle { color: #666; margin-bottom: 30px; font-size: 16px; text-align: center; }
        .vk-button {
            background: #4a76a8; color: white; border: none; padding: 18px 30px;
            border-radius: 14px; font-size: 18px; font-weight: 600; cursor: pointer;
            width: 100%; margin: 20px 0;
        }
        .vk-button:hover { background: #3a5f87; }
        .loading { display: none; text-align: center; margin: 30px 0; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #4a76a8; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .token-result {
            background: #f8f9fa; border-radius: 20px; padding: 25px; margin: 25px 0;
            display: none; border: 2px solid #4a76a8;
        }
        .user-info { background: #e8f0fe; padding: 15px; border-radius: 12px; margin: 15px 0; border-left: 4px solid #4a76a8; }
        .token-box { background: white; padding: 20px; border-radius: 12px; word-break: break-all; font-family: 'Courier New', monospace; font-size: 14px; border: 1px solid #e0e0e0; margin: 15px 0; max-height: 180px; overflow-y: auto; }
        .copy-button { background: #28a745; color: white; border: none; padding: 15px 25px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; }
        .copy-button:hover { background: #218838; }
        .error-message { background: #ffebee; color: #b71c1c; padding: 15px; border-radius: 12px; margin: 15px 0; display: none; }
        .warning { background: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 18px; border-radius: 14px; margin: 25px 0 0; }
        .debug-info { background: #f0f0f0; padding: 10px; border-radius: 8px; font-family: monospace; font-size: 12px; margin: 10px 0; white-space: pre-wrap; display: none; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="card">
        <h1>üîë VK –¢–æ–∫–µ–Ω –•–µ–ª–ø–µ—Ä</h1>
        <p class="subtitle">–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É ‚Äî —Ä–∞–∑—Ä–µ—à–∏ –¥–æ—Å—Ç—É–ø ‚Äî —Ç–æ–∫–µ–Ω –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</p>
        <button class="vk-button" id="authBtn" onclick="startAuth()">üîµ –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –í–ö–æ–Ω—Ç–∞–∫—Ç–µ</button>

        <div class="loading" id="loading"><div class="spinner"></div><p>–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞...</p></div>
        <div class="error-message" id="errorMessage"></div>
        <div class="debug-info" id="debugInfo"></div>

        <div class="token-result" id="resultBlock">
            <div class="user-info" id="userInfo"></div>
            <div class="token-box" id="tokenDisplay"></div>
            <button class="copy-button" id="copyBtn" onclick="copyToken()">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω</button>
        </div>
        <div class="warning">‚ö†Ô∏è –¢–æ–∫–µ–Ω ‚Äî –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–∫–∫–∞—É–Ω—Ç—É. –ù–∏–∫–æ–º—É –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ –µ–≥–æ.</div>
    </div>

    <script>
        // =============================================
        // –ù–ê–°–¢–†–û–ô–ö–ò - –í–ê–®–ò –î–ê–ù–ù–´–ï
        // =============================================
        const CONFIG = {
            clientId: '54464046',
            redirectUri: 'https://yurijd.github.io/vk-token-helper/',
            proxyUrl: 'https://webkkam.ru/proxy.php', // –°–Ω–æ–≤–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–∞—à –ø—Ä–æ–∫—Å–∏
            scope: 'messages,friends,photos,wall,groups',
            v: '5.199'
        };

        let currentToken = '';

        function generateRandomString(length) { /* ... —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å, –æ—Å—Ç–∞–≤—å—Ç–µ –∫–∞–∫ –µ—Å—Ç—å */ }
        function base64URLEncode(buffer) { /* ... */ }
        async function generateCodeChallenge(verifier) { /* ... */ }
        function debugLog(...args) { /* ... */ }
        function showError(message) { /* ... */ }
        async function copyToken() { /* ... */ }

        // =============================================
        // –®–ê–ì 1: –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø (–æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ VK)
        // =============================================
        window.startAuth = async function() {
            try {
                const state = generateRandomString(32);
                const codeVerifier = generateRandomString(43);
                const codeChallenge = await generateCodeChallenge(codeVerifier);

                sessionStorage.setItem('vk_state', state);
                sessionStorage.setItem('vk_code_verifier', codeVerifier);
                debugLog('üöÄ –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ VK...');

                const params = new URLSearchParams({
                    client_id: CONFIG.clientId, redirect_uri: CONFIG.redirectUri,
                    response_type: 'code', scope: CONFIG.scope, state: state,
                    code_challenge: codeChallenge, code_challenge_method: 'S256',
                    v: CONFIG.v, display: 'page'
                });
                window.location.href = `https://id.vk.ru/authorize?${params.toString()}`;
            } catch (error) { showError('–û—à–∏–±–∫–∞: ' + error.message); }
        };

        // =============================================
        // –®–ê–ì 2: –û–ë–†–ê–ë–û–¢–ö–ê –í–û–ó–í–†–ê–¢–ê (—Ç—É—Ç –≤—Å—ë –±—ã–ª–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ)
        // =============================================
        async function handleCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            const returnedState = urlParams.get('state');
            const savedState = sessionStorage.getItem('vk_state');
            const codeVerifier = sessionStorage.getItem('vk_code_verifier');

            debugLog('üì• –ü–æ–ª—É—á–µ–Ω code:', code ? '‚úÖ' : '‚ùå');
            if (error) { showError(error + ': ' + (urlParams.get('error_description') || '')); return; }
            if (!code) { debugLog('‚ÑπÔ∏è –ù–µ—Ç code, –æ–±—ã—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞'); return; }
            if (!returnedState || returnedState !== savedState) { showError('–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: –Ω–µ–≤–µ—Ä–Ω—ã–π state'); return; }
            if (!codeVerifier) { showError('–û—à–∏–±–∫–∞: code_verifier –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('authBtn').disabled = true;

            try {
                debugLog('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º code –Ω–∞ proxy.php...');
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º code –Ω–∞ –≤–∞—à —Å–µ—Ä–≤–µ—Ä
                const response = await fetch(CONFIG.proxyUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code, code_verifier: codeVerifier })
                });

                const responseText = await response.text();
                debugLog('üì• –û—Ç–≤–µ—Ç –æ—Ç proxy (–ø–µ—Ä–≤—ã–µ 100):', responseText.substring(0, 100));

                if (!response.ok) {
                    throw new Error(`HTTP –æ—à–∏–±–∫–∞ ${response.status}: ${responseText.substring(0, 100)}`);
                }

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    debugLog('‚ùå –ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç:', responseText);
                    throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ JSON. –û—Ç–≤–µ—Ç: ' + responseText.substring(0, 200));
                }

                if (data.error) { throw new Error(data.error_description || data.error); }
                if (!data.access_token) { throw new Error('–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –≤ –æ—Ç–≤–µ—Ç–µ'); }

                // ===== –≠–¢–û–¢ –ë–õ–û–ö –ö–û–î–ê –ù–£–ñ–ù–û –ë–´–õ–û –†–ê–°–ö–û–ú–ú–ï–ù–¢–ò–†–û–í–ê–¢–¨ =====
                // –ü–û–ö–ê–ó–´–í–ê–ï–ú –¢–û–ö–ï–ù –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Æ –ù–ê –°–¢–†–ê–ù–ò–¶–ï
                currentToken = data.access_token;
                document.getElementById('tokenDisplay').textContent = data.access_token;
                document.getElementById('userInfo').innerHTML = `
                    <strong>üë§ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</strong> ${data.user_id || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}<br>
                    <strong>‚è± –î–µ–π—Å—Ç–≤—É–µ—Ç:</strong> ${data.expires_in ? Math.floor(data.expires_in/60) + ' –º–∏–Ω' : '1 —á–∞—Å'}
                `;
                document.getElementById('resultBlock').style.display = 'block';
                debugLog('‚úÖ –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω –∏ –æ—Ç–æ–±—Ä–∞–∂—ë–Ω –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ!');
                // =======================================================

                sessionStorage.removeItem('vk_state');
                sessionStorage.removeItem('vk_code_verifier');
                window.history.replaceState({}, document.title, window.location.pathname);

            } catch (error) {
                showError('–û—à–∏–±–∫–∞: ' + error.message);
                debugLog('‚ùå –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', error);
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('authBtn').disabled = false;
            }
        }
        window.onload = handleCallback;
    </script>
</body>
</html>
